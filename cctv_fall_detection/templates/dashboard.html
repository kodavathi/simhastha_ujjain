<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CCTV Fall Detection Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-3">⚠️ CCTV Fall Detection Dashboard</h2>
    <hr>

    <!-- Live Video Feed -->
    <h4>Live Feed</h4>
    <img id="live-video" src="{{ url_for('serve_snapshot', filename='latest.jpg') }}" 
         class="img-fluid rounded border mb-4">

    <!-- Recent Alerts -->
    <h4>Recent Alerts</h4>
    <div id="alerts">
        {% if alerts %}
            {% for alert in alerts|reverse %}
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <p><strong>Person ID:</strong> {{ alert.person_id }}</p>
                    <p><strong>Timestamp:</strong> {{ alert.timestamp }}</p>
                    <p><strong>Location:</strong> {{ alert.location }}</p>
                    {% if alert.snapshot %}
                        <img src="{{ url_for('serve_snapshot', filename=alert.snapshot) }}" 
                            width="220" class="rounded border">
                    {% endif %}

                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No alerts yet.</p>
        {% endif %}
    </div>
</div>

<script>
    // Auto-refresh live video every 0.5 sec
    const liveVideo = document.getElementById('live-video');
    function refreshLiveFeed() {
        const timestamp = new Date().getTime();
        liveVideo.src = "{{ url_for('serve_snapshot', filename='latest.jpg') }}?t=" + timestamp;
    }
    setInterval(refreshLiveFeed, 500);

    // Refresh alerts every 2 sec
    async function refreshAlerts() {
        try {
            const res = await fetch('/');
            const html = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newAlerts = doc.getElementById('alerts').innerHTML;
            document.getElementById('alerts').innerHTML = newAlerts;
        } catch (err) {
            console.error("Failed to refresh alerts:", err);
        }
    }
    setInterval(refreshAlerts, 2000);
</script>
</body>
</html>
